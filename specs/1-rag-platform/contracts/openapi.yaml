openapi: 3.0.0
info:
  title: Physical AI & Humanoid Robotics Learning Platform API
  description: FastAPI backend for RAG chatbot, authentication, and curriculum delivery
  version: 1.0.0
servers:
  - url: https://api.example.com
    description: Production backend
  - url: http://localhost:8000
    description: Local development

tags:
  - name: Authentication
    description: User signup, signin, and session management
  - name: Chapters
    description: Curriculum content retrieval and search
  - name: Chatbot
    description: RAG chatbot interactions with selected-text context
  - name: User Profile
    description: User preferences and profile management

paths:
  /auth/signup:
    post:
      tags:
        - Authentication
      summary: User registration with background context
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid input or email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/signin:
    post:
      tags:
        - Authentication
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SigninRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chapters:
    get:
      tags:
        - Chapters
      summary: List all chapters with optional filtering
      parameters:
        - name: search
          in: query
          description: Full-text search in chapter titles and content
          schema:
            type: string
        - name: module
          in: query
          description: Filter by module number (1-4)
          schema:
            type: integer
            minimum: 1
            maximum: 4
        - name: week
          in: query
          description: Filter by week number (1-13)
          schema:
            type: integer
            minimum: 1
            maximum: 13
      responses:
        '200':
          description: List of chapters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChapterSummary'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chapters/{chapter_id}:
    get:
      tags:
        - Chapters
      summary: Get full chapter content
      parameters:
        - name: chapter_id
          in: path
          required: true
          description: Chapter UUID
          schema:
            type: string
            format: uuid
        - name: proficiency_level
          in: query
          description: Request content for specific proficiency level
          schema:
            type: string
            enum: [Beginner, Intermediate, Advanced]
      responses:
        '200':
          description: Full chapter content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chapter'
        '404':
          description: Chapter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chatbot/select-text:
    post:
      tags:
        - Chatbot
      summary: Store selected text context for RAG
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SelectTextRequest'
      responses:
        '201':
          description: Text context stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SelectTextResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chatbot/query:
    post:
      tags:
        - Chatbot
      summary: Query chatbot with selected-text context (RAG)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatbotQueryRequest'
      responses:
        '200':
          description: RAG response with citation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatbotQueryResponse'
        '400':
          description: Invalid request or no context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable (Qdrant/API failure)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /user/profile:
    get:
      tags:
        - User Profile
      summary: Get user profile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - User Profile
      summary: Update user profile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    SignupRequest:
      type: object
      required:
        - email
        - password
        - background
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        background:
          type: string
          enum: [AI/ML, Embedded Systems, Robotics, Other]
        background_custom:
          type: string
          description: Custom background details if "Other" selected
          maxLength: 500

    SigninRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        email:
          type: string
        token:
          type: string
          description: JWT access token
        background:
          type: string
        proficiency_level:
          type: string
          enum: [Beginner, Intermediate, Advanced]

    ChapterSummary:
      type: object
      properties:
        chapter_id:
          type: string
          format: uuid
        title:
          type: string
        module_id:
          type: integer
        week_number:
          type: integer
        learning_outcomes:
          type: array
          items:
            type: string

    Chapter:
      type: object
      properties:
        chapter_id:
          type: string
          format: uuid
        title:
          type: string
        module_id:
          type: integer
        week_number:
          type: integer
        learning_outcomes:
          type: array
          items:
            type: string
        content:
          type: string
          description: Full markdown/HTML content
        prerequisites:
          type: array
          items:
            type: string
        tags:
          type: array
          items:
            type: string
        authors:
          type: array
          items:
            type: string
        last_updated:
          type: string
          format: date-time

    SelectTextRequest:
      type: object
      required:
        - chapter_id
        - text_content
        - char_position_start
        - char_position_end
      properties:
        chapter_id:
          type: string
          format: uuid
        text_content:
          type: string
          description: Selected text excerpt
          maxLength: 2000
        char_position_start:
          type: integer
          minimum: 0
        char_position_end:
          type: integer
          minimum: 0

    SelectTextResponse:
      type: object
      properties:
        context_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [saved]
        timestamp:
          type: string
          format: date-time

    ChatbotQueryRequest:
      type: object
      required:
        - question
        - context_id
      properties:
        question:
          type: string
          minLength: 3
          maxLength: 500
        context_id:
          type: string
          format: uuid
          description: From previous select-text call

    ChatbotQueryResponse:
      type: object
      properties:
        answer:
          type: string
          description: RAG response
        citation:
          type: object
          properties:
            chapter:
              type: string
            section:
              type: string
            quote:
              type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence score of answer

    UserProfile:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        email:
          type: string
        background:
          type: string
        proficiency_level:
          type: string
          enum: [Beginner, Intermediate, Advanced]
        language_preference:
          type: string
          enum: [en, ur]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateProfileRequest:
      type: object
      properties:
        proficiency_level:
          type: string
          enum: [Beginner, Intermediate, Advanced]
        language_preference:
          type: string
          enum: [en, ur]

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        status_code:
          type: integer

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
